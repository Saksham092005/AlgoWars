<!-- frontend/views/dashboard.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Devbits - Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <!-- Include Chart.js for the rating graph -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <%- include('partials/header', { user: user }) %>

  <div class="dashboard-container">
    <h1>Welcome, <%= user.username %>!</h1>
    
    <section class="profile-section">
      <h2>Your Codeforces Profile</h2>
      <div class="profile-stats">
        <div class="profile-stat">
          <h3>Handle</h3>
          <p><%= userInfo.handle %></p>
        </div>
        <div class="profile-stat">
          <h3>Rating</h3>
          <p><%= userInfo.rating %></p>
        </div>
        <div class="profile-stat">
          <h3>Rank</h3>
          <p><%= userInfo.rank %></p>
        </div>
      </div>
    </section>
    
    <section class="contest-history">
      <h2>Contest History</h2>
      <table>
        <thead>
          <tr>
            <th>Contest Name</th>
            <th>Rank</th>
            <th>Rating Change</th>
            <th>New Rating</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <% contestHistory.forEach(contest => { %>
            <tr>
              <td><%= contest.contestName %></td>
              <td><%= contest.rank %></td>
              <td><%= contest.newRating - contest.oldRating %></td>
              <td><%= contest.newRating %></td>
              <td><%= new Date(contest.ratingUpdateTimeSeconds * 1000).toLocaleDateString() %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
    
    <!-- Performance Analytics Section -->
    <section class="performance-analytics">
      <h2>Performance Analytics</h2>
      
      <!-- 1. Rating Graph -->
      <div class="rating-graph">
        <h3>Rating Over Time</h3>
        <canvas id="ratingChart"></canvas>
      </div>
      
      <!-- 2. Streak Tracker -->
      <div class="streak-tracker">
        <h3>Streak Tracker</h3>
        <p>Current Active Streak: <strong><%= currentStreak %> days</strong></p>
        <p>Active Days:</p>
        <ul class="active-days">
          <% activeDays.forEach(day => { %>
            <li><%= day %></li>
          <% }) %>
        </ul>
      </div>
      
      <!-- 3. Weak Topics -->
      <div class="weak-topics">
        <h3>Weak Topics</h3>
        <ul>
          <% Object.keys(weakTopics).forEach(tag => { %>
            <li><%= tag %> - <%= weakTopics[tag] %> wrong submissions</li>
          <% }) %>
        </ul>
      </div>
    </section>
  </div>

  <%- include('partials/footer') %>

  <!-- Chart.js script to render the rating graph -->
  <script>
    // Prepare data for the rating graph from contestHistory
    const contests = <%- JSON.stringify(contestHistory) %>;
    const labels = contests.map(contest => {
      const d = new Date(contest.ratingUpdateTimeSeconds * 1000);
      return d.toLocaleDateString();
    });
    const ratings = contests.map(contest => contest.newRating);

    const ctx = document.getElementById('ratingChart').getContext('2d');
    const ratingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'CF Rating',
          data: ratings,
          borderColor: '#2BAF67',
          backgroundColor: 'rgba(43, 175, 103, 0.2)',
          fill: true,
          tension: 0.2
        }]
      },
      options: {
        scales: {
          x: {
            title: { display: true, text: 'Date' }
          },
          y: {
            title: { display: true, text: 'Rating' },
            beginAtZero: false
          }
        }
      }
    });
  </script>
</body>
</html>
